From e615f860a5b595900ee1b649e19ed6580b28f196 Mon Sep 17 00:00:00 2001
From: Philip Balister <philip@opensdr.com>
Date: Fri, 14 Jun 2013 12:12:00 -0400
Subject: [PATCH 1/4] Read mac address from i2c EEPROM.

Signed-off-by: Philip Balister <philip@opensdr.com>
---
 board/xilinx/zynq/board.c     | 25 +++++++++++++++++++++++++
 include/configs/zynq_common.h |  1 -
 2 files changed, 25 insertions(+), 1 deletion(-)

diff --git a/board/xilinx/zynq/board.c b/board/xilinx/zynq/board.c
index 5be4851..f0c2b4e 100644
--- a/board/xilinx/zynq/board.c
+++ b/board/xilinx/zynq/board.c
@@ -48,6 +48,29 @@ Xilinx_desc fpga045 = XILINX_XC7Z045_DESC(0x45);
 Xilinx_desc fpga100 = XILINX_XC7Z100_DESC(0x100);
 #endif
 
+static void ethaddr_init(void)
+{
+	u8 mac[6];
+	char mstr[20];
+
+	i2c_init(0, 0);
+
+	i2c_set_bus_num(0);
+
+	if (i2c_probe(0x50) != 0) {
+		printf("Could find i2c eeprom.\n");
+		return;
+	}       
+
+	if (i2c_read(0x50, 4, 1, mac, 6))
+		printf("i2c_read failed\n");
+
+	sprintf(mstr, "%0X:%0X:%0X:%0X:%0X:%0X",mac[0], mac[1], mac[2], mac[3], mac[4], mac[5]); 
+	printf("ethaddr set to: %s\n", mstr);
+	setenv("ethaddr", mstr);                
+}
+
+
 int board_init(void)
 {
 #ifdef CONFIG_FPGA
@@ -109,6 +132,8 @@ int board_late_init(void)
 		break;
 	}
 
+	ethaddr_init();
+
 	return 0;
 }
 
diff --git a/include/configs/zynq_common.h b/include/configs/zynq_common.h
index 762aaca..4674237 100644
--- a/include/configs/zynq_common.h
+++ b/include/configs/zynq_common.h
@@ -231,7 +231,6 @@
 
 /* Default environment */
 #define CONFIG_EXTRA_ENV_SETTINGS	\
-	"ethaddr=00:0a:35:00:01:22\0"	\
 	"kernel_image=uImage\0"	\
 	"ramdisk_image=uramdisk.image.gz\0"	\
 	"devicetree_image=devicetree.dtb\0"	\
-- 
1.8.3.1

