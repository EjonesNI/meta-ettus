From 5c5a92b048ea6ae18d20ae1e69ebff7aab503258 Mon Sep 17 00:00:00 2001
From: Philip Balister <philip@opensdr.com>
Date: Wed, 14 Dec 2016 16:43:28 -0800
Subject: [PATCH 3/4] Updates to Ettus Sulfur for use with mender.

Signed-off-by: Philip Balister <philip@opensdr.com>
---
 configs/ni_sulfur_rev2_defconfig | 1 +
 include/configs/ni_sulfur_rev2.h | 5 +++--
 include/configs/zynq-common.h    | 1 -
 3 files changed, 4 insertions(+), 3 deletions(-)

diff --git a/configs/ni_sulfur_rev2_defconfig b/configs/ni_sulfur_rev2_defconfig
index c7d8756..d16ed23 100644
--- a/configs/ni_sulfur_rev2_defconfig
+++ b/configs/ni_sulfur_rev2_defconfig
@@ -5,6 +5,7 @@ CONFIG_ARCH_ZYNQ=y
 CONFIG_DEFAULT_DEVICE_TREE="zynq-ni-sulfur-rev2"
 CONFIG_FIT=y
 CONFIG_SYS_NO_FLASH=y
+CONFIG_SYS_EXTRA_OPTIONS="BOOTCOUNT_LIMIT,BOOTCOUNT_ENV,ENV_IS_IN_MMC"
 # CONFIG_DISPLAY_CPUINFO is not set
 CONFIG_SPL=y
 CONFIG_HUSH_PARSER=y
diff --git a/include/configs/ni_sulfur_rev2.h b/include/configs/ni_sulfur_rev2.h
index 2aa2f90..1e06e97 100644
--- a/include/configs/ni_sulfur_rev2.h
+++ b/include/configs/ni_sulfur_rev2.h
@@ -15,6 +15,7 @@
 #undef CONFIG_EXTRA_ENV_SETTINGS
 #define CONFIG_EXTRA_ENV_SETTINGS	\
 	"fit_image=fit.itb\0"		\
+	"bootargs=root=${mender_kernel_root} rw rootwait\0" \
 	"load_addr=0x2000000\0"		\
 	"fit_size=0x800000\0"		\
 	"fdt_high=0x20000000\0"		\
@@ -43,8 +44,8 @@
 				"run uenvcmd; " \
 			"fi; " \
 		"fi; \0" \
-	"sdboot=echo Copying FIT from SD to RAM... && " \
-		"load mmc 0 ${load_addr} ${fit_image} && " \
+	"sdboot=run mender_setup; echo Copying FIT from SD to RAM... && " \
+		"load ${mender_uboot_root} ${load_addr} ${fit_image} && " \
 		"bootm ${load_addr}\0" \
 	"jtagboot=echo TFTPing FIT to RAM... && " \
 		"tftpboot ${load_addr} ${fit_image} && " \
diff --git a/include/configs/zynq-common.h b/include/configs/zynq-common.h
index 997ce72..0f72c40 100644
--- a/include/configs/zynq-common.h
+++ b/include/configs/zynq-common.h
@@ -166,7 +166,6 @@
 /* Environment */
 #ifndef CONFIG_ENV_IS_NOWHERE
 # define CONFIG_ENV_SECT_SIZE		CONFIG_ENV_SIZE
-# define CONFIG_ENV_OFFSET		0xE0000
 #endif
 
 /* enable preboot to be loaded before CONFIG_BOOTDELAY */
-- 
2.7.4

