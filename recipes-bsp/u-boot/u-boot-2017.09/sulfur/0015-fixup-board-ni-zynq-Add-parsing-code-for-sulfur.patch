From 47e2361969aca7f435d4f7fa94b04257bd5a5983 Mon Sep 17 00:00:00 2001
From: Moritz Fischer <moritz.fischer@ettus.com>
Date: Fri, 3 Nov 2017 17:23:56 -0700
Subject: [PATCH 15/15] fixup! board: ni: zynq: Add parsing code for sulfur

Signed-off-by: Moritz Fischer <moritz.fischer@ettus.com>
---
 board/ni/zynq/board.c            | 23 ++++++++++++++++++++---
 include/configs/ni_sulfur_rev3.h |  4 +++-
 2 files changed, 23 insertions(+), 4 deletions(-)

diff --git a/board/ni/zynq/board.c b/board/ni/zynq/board.c
index 30ec1d1de84..da4eacabb5e 100644
--- a/board/ni/zynq/board.c
+++ b/board/ni/zynq/board.c
@@ -131,6 +131,9 @@ int board_init(void)
 int board_late_init(void)
 {
 	int slot0, slot1;
+	int rev;
+	char base_fdt[128];
+	char overlay[128];
 
 	switch ((zynq_slcr_get_boot_mode()) & ZYNQ_BM_MASK) {
 	case ZYNQ_BM_QSPI:
@@ -157,7 +160,14 @@ int board_late_init(void)
 	board_power(BOARD_POWER_TYPE_ON);
 #endif
 
-	sulfur_probe_mboard();
+	rev = sulfur_probe_mboard();
+	if (rev > 0) {
+		snprintf(base_fdt, 128, "sulfur-rev%u", rev+1);
+		env_set("variant", base_fdt);
+	} else {
+		snprintf(base_fdt, 128, "sulfur-rev3");
+		env_set("variant", base_fdt);
+	}
 
 	slot0 = sulfur_probe_dboard(0);
 	slot1 = sulfur_probe_dboard(1);
@@ -165,13 +175,20 @@ int board_late_init(void)
 	if (((slot0 == 0x150) && (slot1 == 0x150)) ||
 		(slot0 < 0 && slot1 == 0x150) ||
 		(slot1 < 0 && slot0 == 0x150)) {
+		//env_set("overlay","magnesium");
 		env_set("variant","magnesium");
 	} else if (((slot0 == 0x180) && (slot1 == 0x180)) ||
 		(slot0 < 0 && slot1 == 0x180) ||
 		(slot1 < 0 && slot0 == 0x180)) {
-		env_set("variant", "eiscat");
+		//env_set("overlay", "eiscat");
+		env_set("variant","eiscat");
+	} else if (((slot0 == 0x152) && (slot1 == 0x152)) ||
+		(slot0 < 0 && slot1 == 0x152) ||
+		(slot1 < 0 && slot0 == 0x152)) {
+		//env_set("overlay", "rhodium");
+		env_set("variant","rhodium");
 	} else {
-		env_set("variant", "sulfur-rev-3");
+		env_set("overlay", "");
 		printf("No known dboard found, falling back to sulfur-rev3\n");
 	}
 
diff --git a/include/configs/ni_sulfur_rev3.h b/include/configs/ni_sulfur_rev3.h
index 5c236ba4e04..fab168bc652 100644
--- a/include/configs/ni_sulfur_rev3.h
+++ b/include/configs/ni_sulfur_rev3.h
@@ -21,7 +21,8 @@
 	"variant=sulfur-rev3\0"	\
 	"fit_image=boot/fitImage\0"	\
 	"ec_disable_swsync=0\0"		\
-	"ec_image=lib/firmware/ni/ec-sulfur-rev3.RW.bin\0"	\
+	"expand_ec_image=setenv ec_image lib/firmware/ni/ec-${variant}.RW.bin\0" \
+	"expand_overlay=setenv db_overlay_dtbo conf@${overlay}.dtb\0" \
 	"bootargs=root=${mender_kernel_root} rw rootwait uio_pdrv_genirq.of_id=usrp-uio\0" \
 	"load_addr=0x2000000\0"		\
 	"fit_size=0x800000\0"           \
@@ -30,6 +31,7 @@
 	"sdboot=run mender_setup; " \
 		"if test ${ec_disable_swsync} = 0; then "\
 			"echo Copying MCU FW from SD to RAM... && " \
+			"run expand_ec_image; " \
 			"ext4load ${mender_uboot_root} ${load_addr} ${ec_image} && " \
 			"crosec swsync ${load_addr} ${filesize}; fi;" \
 		"echo Copying FIT from SD to RAM... && " \
-- 
2.14.2

