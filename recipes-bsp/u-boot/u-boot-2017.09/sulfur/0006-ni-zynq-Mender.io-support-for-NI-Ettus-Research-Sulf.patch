From 7357b6725d626728e02fbd609642f27ca85e5fa9 Mon Sep 17 00:00:00 2001
From: Moritz Fischer <moritz.fischer@ettus.com>
Date: Wed, 17 May 2017 14:03:11 -0700
Subject: [PATCH 06/13] ni: zynq: Mender.io support for NI Ettus Research
 Sulfur Rev3 SDR

This involves adding bootcount in environment, as well as modifying
the default bootconfiguration to run ${mender_setup} first.

Signed-off-by: Moritz Fischer <moritz.fischer@ettus.com>
---
 arch/arm/dts/zynq-ni-sulfur-rev3.dts | 50 ++++++++++++++++--------------------
 configs/ni_sulfur_rev3_defconfig     |  2 +-
 include/configs/ni_sulfur_rev3.h     | 20 +++++++--------
 3 files changed, 32 insertions(+), 40 deletions(-)

diff --git a/arch/arm/dts/zynq-ni-sulfur-rev3.dts b/arch/arm/dts/zynq-ni-sulfur-rev3.dts
index 6812731a8b..cb32825748 100644
--- a/arch/arm/dts/zynq-ni-sulfur-rev3.dts
+++ b/arch/arm/dts/zynq-ni-sulfur-rev3.dts
@@ -64,6 +64,8 @@
 		i2c0 = &i2c0;
 		i2c1 = &i2c1;
 		i2c20 = &tun;
+		i2c706 = &i2c0_70_6;
+		i2c707 = &i2c0_70_7;
 	};
 
 	memory {
@@ -138,31 +140,16 @@
 	clock-frequency = <400000>;
 
 	i2cswitch@70 {
-		compatible = "ti,pca9548";
+		compatible = "nxp,pca9548";
 		#address-cells = <1>;
 		#size-cells = <0>;
 		reg = <0x70>;
+		status = "okay";
 
 		reset-gpios = <&gpio0 7 GPIO_ACTIVE_LOW>;
 
-		i2c@0 {
-			reg = <0>;
-			status = "disabled";
-		};
-
-		i2c@1 {
-			reg = <1>;
-			status = "disabled";
-		};
-
-		i2c@2 {
-			reg = <2>;
-			status = "disabled";
-		};
-
-		i2c@3 {
+		i2c0_70_3: i2c@3 {
 			reg = <3>;
-			status = "okay";
 			#address-cells = <1>;
 			#size-cells = <0>;
 
@@ -174,12 +161,7 @@
 			};
 		};
 
-		i2c@4 {
-			reg = <4>;
-			status = "disabled";
-		};
-
-		i2c@5 {
+		i2c0_70_5: i2c@5 {
 			reg = <5>;
 			status = "okay";
 			#address-cells = <1>;
@@ -191,18 +173,30 @@
 			};
 		};
 
-		usrpio_i2c0: i2c@6 {
+		i2c0_70_6: i2c@6 {
 			#address-cells = <1>;
 			#size-cells = <0>;
 
 			reg = <6>;
+
+			nvmem2: eeprom@50 {
+				compatible = "atmel,24c256";
+				reg = <0x50>;
+			};
+
 		};
 
-		usrpio_i2c1: i2c@7 {
+		i2c0_70_7: i2c@7 {
 			#address-cells = <1>;
 			#size-cells = <0>;
 
-			reg = <6>;
+			reg = <7>;
+
+			nvmem3: eeprom@50 {
+				compatible = "atmel,24c256";
+				reg = <0x50>;
+			};
+
 		};
 	};
 };
@@ -229,7 +223,7 @@
 			clock-frequency = <50000>;
 
 			nvmem0: eeprom@50 {
-				compatible = "at,24c02";
+				compatible = "atmel,24c02";
 				reg = <0x50>;
 			};
 		};
diff --git a/configs/ni_sulfur_rev3_defconfig b/configs/ni_sulfur_rev3_defconfig
index d22b246e86..3f4379045c 100644
--- a/configs/ni_sulfur_rev3_defconfig
+++ b/configs/ni_sulfur_rev3_defconfig
@@ -4,7 +4,7 @@ CONFIG_SYS_CONFIG_NAME="ni_sulfur_rev3"
 CONFIG_ARCH_ZYNQ=y
 CONFIG_SYS_TEXT_BASE=0x4000000
 CONFIG_DEFAULT_DEVICE_TREE="zynq-ni-sulfur-rev3"
-CONFIG_SYS_EXTRA_OPTIONS="ENV_IS_IN_MMC"
+CONFIG_SYS_EXTRA_OPTIONS="BOOTCOUNT_LIMIT,BOOTCOUNT_ENV,ENV_IS_IN_MMC"
 CONFIG_FIT=y
 CONFIG_BOOTSTAGE_STASH_SIZE=4096
 # CONFIG_DISPLAY_CPUINFO is not set
diff --git a/include/configs/ni_sulfur_rev3.h b/include/configs/ni_sulfur_rev3.h
index 695e44747c..5c236ba4e0 100644
--- a/include/configs/ni_sulfur_rev3.h
+++ b/include/configs/ni_sulfur_rev3.h
@@ -16,27 +16,25 @@
 #include "zynq-common.h"
 #undef CONFIG_ENV_IS_NOWHERE
 
-#define CONFIG_SYS_MMC_ENV_DEV 0
-#define CONFIG_ENV_SECT_SIZE		CONFIG_ENV_SIZE
-#define CONFIG_ENV_OFFSET		0xE0000
-
 #undef CONFIG_EXTRA_ENV_SETTINGS
 #define CONFIG_EXTRA_ENV_SETTINGS	\
-	"fit_image=fit.itb\0"		\
+	"variant=sulfur-rev3\0"	\
+	"fit_image=boot/fitImage\0"	\
 	"ec_disable_swsync=0\0"		\
-	"ec_image=ec-sulfur-rev3.RW.bin\0" \
-	"bootargs=root=/dev/mmcblk0p2 rw rootwait uio_pdrv_genirq.of_id=usrp-uio\0" \
+	"ec_image=lib/firmware/ni/ec-sulfur-rev3.RW.bin\0"	\
+	"bootargs=root=${mender_kernel_root} rw rootwait uio_pdrv_genirq.of_id=usrp-uio\0" \
 	"load_addr=0x2000000\0"		\
 	"fit_size=0x800000\0"           \
 	"fdt_high=0x20000000\0"         \
 	"initrd_high=0x20000000\0"      \
-	"sdboot=if test ${ec_disable_swsync} = 0; then \
+	"sdboot=run mender_setup; " \
+		"if test ${ec_disable_swsync} = 0; then "\
 			"echo Copying MCU FW from SD to RAM... && " \
-			"load mmc 0 ${load_addr} ${ec_image} && " \
+			"ext4load ${mender_uboot_root} ${load_addr} ${ec_image} && " \
 			"crosec swsync ${load_addr} ${filesize}; fi;" \
 		"echo Copying FIT from SD to RAM... && " \
-		"load mmc 0 ${load_addr} ${fit_image} && " \
-		"bootm ${load_addr}\0" \
+		"ext4load ${mender_uboot_root} ${load_addr} ${fit_image} && " \
+		"bootm ${load_addr}#conf@zynq-ni-${variant}.dtb\0" \
 	"jtagboot=echo TFTPing FIT to RAM... && " \
 		"tftpboot ${load_addr} ${fit_image} && " \
 		"bootm ${load_addr}\0" \
-- 
2.14.2

